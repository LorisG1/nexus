#!/bin/bash

# –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
VARS_FILE="/root/.nexus_vars"
BASHRC_FILE="/root/.bashrc"

# === 1. –í–≤–æ–¥ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –∏—Ö –µ—â—ë –Ω–µ—Ç ===
if [[ ! -f "$VARS_FILE" ]]; then
  read -p "–í–≤–µ–¥–∏—Ç–µ Node ID: " NODE_ID
  echo ""
  echo "üí° –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –º–æ—â–Ω—ã–π, —Ç–æ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ñ–∞—Ä–º–∏—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤."
  echo "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—É --max-threads:"
  echo "üñ•  4 CPU / 8 GB RAM    ‚Üí --max-threads 4"
  echo "üñ•  8 CPU / 16 GB RAM   ‚Üí --max-threads 8"
  echo "üìâ –ï—Å–ª–∏ –Ω–æ–¥–∞ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è ‚Äî —É–º–µ–Ω—å—à–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞."
  echo ""
  read -p "–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ (--max-threads): " MAX_THREADS

  echo "NODE_ID=$NODE_ID" > "$VARS_FILE"
  echo "MAX_THREADS=$MAX_THREADS" >> "$VARS_FILE"
else
  source "$VARS_FILE"
fi

# === 1.5. –î–æ–±–∞–≤–ª—è–µ–º –≤ .bashrc –∞–≤—Ç–æ–ø–æ–¥–≥—Ä—É–∑–∫—É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ ===
if ! grep -q "$VARS_FILE" "$BASHRC_FILE"; then
  echo "" >> "$BASHRC_FILE"
  echo "# –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Nexus" >> "$BASHRC_FILE"
  echo "[ -f $VARS_FILE ] && source $VARS_FILE" >> "$BASHRC_FILE"
  echo "üìå –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ $BASHRC_FILE"
fi

# === 2. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∏ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏–∏ ===
LOCAL_VERSION=$(docker run --rm nexusxyz/nexus-cli:latest --version 2>/dev/null)
docker pull nexusxyz/nexus-cli:latest > /dev/null
REMOTE_VERSION=$(docker run --rm nexusxyz/nexus-cli:latest --version 2>/dev/null)

echo ""
echo "üîç –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $LOCAL_VERSION"
echo "üåê –ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è: $REMOTE_VERSION"

# === 3. –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ===
if [[ "$LOCAL_VERSION" != "$REMOTE_VERSION" ]]; then
  echo "üöÄ –ù–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è. –û–±–Ω–æ–≤–ª—è–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º..."

  screen -S nexus -X quit 2>/dev/null
  docker stop nexus 2>/dev/null
  docker rm nexus 2>/dev/null

  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º screen, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
  if ! command -v screen &> /dev/null; then
    sudo apt update && sudo apt install screen -y
  fi

  # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –Ω–æ–≤–æ–π screen-—Å–µ—Å—Å–∏–∏
  screen -dmS nexus bash -c "docker run -it --restart always --init --name nexus nexusxyz/nexus-cli:latest start --node-id $NODE_ID --max-threads $MAX_THREADS"

  echo ""
  echo "‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è 'nexus' –∑–∞–ø—É—â–µ–Ω–∞."
else
  echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è."
fi

echo ""
echo "üîß –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: screen -Rd nexus"
